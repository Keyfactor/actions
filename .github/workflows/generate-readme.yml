name: Generate README from templates and data files using doctool
on:
  workflow_call:
    secrets:
      token:
        description: 'Secret token from caller workflow to approve readme'
        required: true
      entra_username:
        description: 'Entra username for authentication'
        required: true
      entra_password:
        description: 'Entra password for authentication'
        required: false
      command_client_id:
        description: 'Command client ID for API authentication'
        required: false
      command_client_secret:
        description: 'Command client secret for API authentication'
        required: false
    inputs:
      command_token_url:
        type: string
        description: 'URL for obtaining command tokens'
        required: false
      command_hostname:
        type: string
        description: 'Command hostname for API endpoints'
        required: false
      command_base_api_path:
        type: string
        description: 'Base API path for the Command API'
        required: false
permissions:
  contents: write

jobs:
  update-docs:
    runs-on: ubuntu-latest
    name: Use private doctool action in public repository
    steps:
      - name: checkout-action
        uses: keyfactor/checkout@v4
        with:
          repository: keyfactor/doctool
          path: doctool
          token: ${{ secrets.token }}

      - name: Show Inputs
        run: |
          echo "Command Token URL: ${{ inputs.command_token_url }}"
          echo "Command Hostname: ${{ inputs.command_hostname }}"
          echo "Command Base API Path: ${{ inputs.command_base_api_path }}"
          echo "Entra Username: ${{ secrets.entra_username }}"
          echo "Entra Password: ${{ secrets.entra_password }}"
          echo "Command Client ID: ${{ secrets.command_client_id }}"
          echo "Command Client Secret: ${{ secrets.command_client_secret }}"

      - name: Set environment variables
        run: |
          echo "DOCTOOL_COMMAND_TOKEN_URL=${{ inputs.command_token_url }}" >> $GITHUB_ENV
          echo "DOCTOOL_COMMAND_HOSTNAME=${{ inputs.command_hostname }}" >> $GITHUB_ENV
          echo "DOCTOOL_COMMAND_BASE_API_PATH=${{ inputs.command_base_api_path }}" >> $GITHUB_ENV
          

      - name: Launch local doctool
        uses: ./doctool
        id: launch-doctool
        with:
          token: ${{ secrets.token }}
          entra_username: ${{ secrets.ENTRA_USERNAME }}
          entra_password: ${{ secrets.ENTRA_PASSWORD }}
          command_client_id: ${{ secrets.COMMAND_CLIENT_ID }}
          command_client_secret: ${{ secrets.COMMAND_CLIENT_SECRET }}
          command_token_url: ${{ vars.DOCTOOL_COMMAND_TOKEN_URL }}
          command_hostname: ${{ vars.DOCTOOL_COMMAND_HOSTNAME }}
          command_base_api_path: ${{ vars.DOCTOOL_COMMAND_BASE_API_PATH }}


